---
layout: post
title: Laravel v5.2 框架学习笔记
author: 孟凡泽
date: 2016-05-27 02:12:40 +0800
tag: PHP
categories: 笔记
---

注：写完上一篇ThinkPHP框架，再写一篇Laravel框架的学习笔记感觉好怪异。主要是因为在知乎上看到了一些PHP框架相关的讨论，有很多人力推Laravel，又说ThinkPHP哪里怎么怎么不合理，代码质量一般，风格糟糕等等……然后就打开Laravel官网看了一眼，仅仅是打开看了一眼，我就决定抛弃掉ThinkPHP转投看着很高大上的Laravel了！！

注2：新开一段理智下来，Laravel更显专业、成熟，学着更具挑战性，我还可能会从其优秀的代码风格中受益，框架自身也足够稳定。当然也不是说ThinkPHP就不好，或许用来写一般的应用同样简洁高效，并且是国产基因，有中文文档，这些都是他的优点。

注3：这里记录下官方文档里最基础的几篇，可以快速入门，了解基本运行流程并新建一个涉及简单数据库读写的站点。

## 安装

需要使用Composer，这个在上次装ThinkPHP的时候已经装了。不使用国内的镜像的话安装速度会很慢。
- 使用Laravel installer：

```bash
composer global require "laravel/install"   # laravel会被安装到：~/.composer/verdor/bin，把它加入PATH
laravel new blog    # 创建一个项目，目录名称为blog
```

- 使用composer create-project：

```bash
composer create-project --prefer-dist laravel/laravel blog
```

## 配置

- 配置文件位于`config`目录。
- 可能要配置Web服务器对`storage`和`bootstrap/cache`目录的访问权限。
- 在`.env`里设置32字符长的Application Kye。

### 配置的访问

```
$value = config('app.timezone');                //可以再设置默认值
config(['app.timezone' => 'America/Chicago']);  //运行时更改设置
```

### 环境配置

- 在`.env`中配置环境信息，其中`APP_ENV`即是环境名。
- 配置会读取到`$_ENV`里，可以用`env('APP_DEBUG', false)`的形式读取。第二个参数是默认值。
- 这个文件不要使用版本控制，而应该添加`.env.example`。
- 可以在代码中这样进行判断当前的环境：

```php
$environment = App::environment();
//或者
if(App::environment('local', 'staging')){
    // 环境是local或者staging
}
//或者
$environment = app()->environment();
```

- 为了提升性能，在生产环境中定期运行`php artisan config:cache`命令将配置文件转成单个文件，在开发环境中不用。
- 开启Maintenance Mode，可以对所有请求展示一个自定义视图，默认是`resources/views/errors/503.blade.php`。应在系统维护期使用。（[更多：关于队列任务和zero-downtime发布的实现](https://laravel.com/docs/5.2/configuration#maintenance-mode)）开启和关闭的指令分别是：

```
php artisan down
php artisan up
```

## Homestead

一个开发用的虚拟机，感觉很厉害的样子。[更多相关](https://laravel.com/docs/5.2/homestead)

## Valet

一个Mac上开发用的虚拟机，好像比上面一个还好用。[更多相关](https://laravel.com/docs/5.2/valet)

## 教程：Basic Task List

### 新建工程

```bash
composer create-project laravel/laravel quickstart --prefer-dist
# 或
laravel new quickstart
```

### 克隆成品(可选)

```bash
git clone https://github.com/laravel/quickstart-basic quickstart
cd quickstart
composer install
php artisan migrate
```

### 准备数据库

#### Database Migrations 

- 使用数据库Migrations来定义数据库的结构和编辑。
- 使用一下命令生成一个新的数据库Migration：

```bash
php artisan make:migration create_tasks_table --create=tasks
```

- 打开生成在`database/migrations`下的文件，增加一个string列：

```php
public function up()
{
   Schema::create('tasks', function (Blueprint $table) {
       $table->increments('id');
       $table->string('name');
       $table->timestamps();
   });
}
```

- 执行migrate：

```php
php artisan migrate
```

#### Eloquent模型

这是Laravel默认的ORM(Object-relation mapper)。

- 使用以下命令为我们刚刚建立在`tasks`数据库中的`Task`模型进行模型生成，生成的`Task.php`位于`app`目录下：

```bash
php artisan make:model Task
```

### 路由

- 默认全部定义在`app/Http/routes.php`中。
- 这里我们需要三种路由：查看任务列表、添加任务、删除任务。

```php
use App\Task;
use Illuminate\Http\Request;

Route::get('/', function () {
    return view('tasks');   //位于resources/views/tasks.blade.php
});

Route::post('/task', function (Request $request) {
    //
});

Route::delete('/task/{task}', function (Task $task) {
    //
});
```

### 布局和视图

- `.blade.php`代表使用Blade模板引擎。
- 建立模板页`resources/views/layouts/app.blade.php`：

```php
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Laravel Quickstart - Basic</title>

        <!-- CSS And JavaScript -->
    </head>

    <body>
        <div class="container">
            <nav class="navbar navbar-default">
                <!-- Navbar Contents -->
            </nav>
        </div>

        @yield('content')
    </body>
</html>
```

- 建立视图页`tasks.blade.php`页：

```php
@extends('layouts.app')

@section('content')

    <!-- Bootstrap Boilerplate... -->

    <div class="panel-body">
        <!-- Display Validation Errors -->
        @include('common.errors')

        <!-- New Task Form -->
        <form action="{{ url('task') }}" method="POST" class="form-horizontal">
            {{ csrf_field() }}

            <!-- Task Name -->
            <div class="form-group">
                <label for="task" class="col-sm-3 control-label">Task</label>

                <div class="col-sm-6">
                    <input type="text" name="name" id="task-name" class="form-control">
                </div>
            </div>

            <!-- Add Task Button -->
            <div class="form-group">
                <div class="col-sm-offset-3 col-sm-6">
                    <button type="submit" class="btn btn-default">
                        <i class="fa fa-plus"></i> Add Task
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- TODO: Current Tasks -->
@endsection
```

### 添加任务

#### 表单验证

- 完成`Route::post`函数：

```php
Route::post('/task', function (Request $request) {
    $validator = Validator::make($request->all(), [
        'name' => 'required|max:255',
    ]);

    if ($validator->fails()) {
        return redirect('/')
            ->withInput()
            ->withErrors($validator);
    }

    // Create The Task...
});
```

- 注意，错误的输入和错误信息会在重定向到`/`后放入到session，这样就可以保持用户的输入状态。
- `withErrors($validator)`函数使得我们可以在view中通过`$errors`访问出错信息。`common.errors`被包含在了我们之前写的`tasks.blade.php`页面中：

```php
<!-- resources/views/common/errors.blade.php -->

@if (count($errors) > 0)
    <!-- Form Error List -->
    <div class="alert alert-danger">
        <strong>Whoops! Something went wrong!</strong>

        <br><br>

        <ul>
            @foreach ($errors->all() as $error)
                <li>{{ $error }}</li>
            @endforeach
        </ul>
    </div>
@endif
```

#### 创建任务

- 继续完善`Route::post`方法，保存正确的数据到数据库：

```php
Route::post('/task', function (Request $request) {
    $validator = Validator::make($request->all(), [
        'name' => 'required|max:255',
    ]);

    if ($validator->fails()) {
        return redirect('/')
            ->withInput()
            ->withErrors($validator);
    }

    $task = new Task;
    $task->name = $request->name;
    $task->save();

    return redirect('/');
});
```

#### 查看所有任务

- 编辑`/`路径：

```php
Route::get('/', function () {
    $tasks = Task::orderBy('created_at', 'asc')->get();

    return view('tasks', [
        'tasks' => $tasks
    ]); //第二个参数：数组中每个key都可在视图模板中作为变量访问
});
```

- 编写`tasks.blade.php`：

```php
@extends('layouts.app')

@section('content')
    <!-- Create Task Form... -->

    <!-- Current Tasks -->
    @if (count($tasks) > 0)
        <div class="panel panel-default">
            <div class="panel-heading">
                Current Tasks
            </div>

            <div class="panel-body">
                <table class="table table-striped task-table">

                    <!-- Table Headings -->
                    <thead>
                        <th>Task</th>
                        <th>&nbsp;</th>
                    </thead>

                    <!-- Table Body -->
                    <tbody>
                        @foreach ($tasks as $task)
                            <tr>
                                <!-- Task Name -->
                                <td class="table-text">
                                    <div>{{ $task->name }}</div>
                                </td>

                                <td>
                                    <!-- TODO: Delete Button -->
                                </td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
        </div>
    @endif
@endsection
```

### 删除任务

#### 添加删除按钮

- 完成`tasks.blade.php`:

```
<tr>
    <!-- Task Name -->
    <td class="table-text">
        <div>{{ $task->name }}</div>
    </td>

    <!-- Delete Button -->
    <td>
        <form action="{{ url('task/'.$task->id) }}" method="POST">
            {{ csrf_field() }}
            {{ method_field('DELETE') }}

            <button type="submit" class="btn btn-danger">
                <i class="fa fa-trash"></i> Delete
            </button>
        </form>
    </td>
</tr>
```

- 注意，HTML表单的method只能是GET或者POST，所以这里不能用DELETE，而是用`{{method_field('DELETE')}}`生成`<input type='hidden' name='_method' value='DELETE'`交给Laravel后台解析。

#### 删除操作

- 完成`/task/{task}`，这里使用了model binding的方式自动去除{task}作为形参，表示要删除的对象。

```
Route::delete('/task/{task}', function (Task $task) {
    $task->delete();

    return redirect('/');
});
```

## 问题解决

### 服务器无响应问题

问题描述：访问 http://seckillphp.ifanze-local.cn/quickstart/public 提示服务器无响应。
问题解决：记得给`storage`就`bootstrap/cache`赋777权限。

### 路由无效

问题描述：访问除主页外的地址，如http://seckillphp.ifanze-local.cn/quickstart/public/task，均显示404错误。
问题解决：这个问题应该出现在第二次开启服务器之后，因为是apache的rewrite模块没有开启或者配置正确的问题：

1. 在`httpd.conf`中取消下面一行前的注释：

```
LoadModule rewrite_module modules/mod_rewrite.so
```

2. 配置`<Directory>`标签，使用：

```
AllowOverride all
```

