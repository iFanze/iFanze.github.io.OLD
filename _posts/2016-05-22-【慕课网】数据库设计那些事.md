---
layout: post
title: 【慕课网】数据库设计那些事
author: 孟凡泽
date: 2016-05-22 23:05:40 +0800
tag: 数据库
categories: 笔记 @慕课网
---

注：这是看了慕课网上一个视频的笔记。是比较基础的数据库相关的知识，比如范式，并且还对数据库设计时需要注意的问题和一些经验性的内容做了分享。原视频链接：[http://www.imooc.com/learn/117](http://www.imooc.com/learn/117)

## 为什么要进行数据库设计

- 减少数据冗余
- 避免数据维护异常
- 节约存储空间
- 高效访问

## 数据库设计步骤

- 需求分析：数据是什么、有哪些属性、数据和属性有哪些特点
- 逻辑设计：用ER图逻辑建模
- 物理设计：根据数据库自身的特点
- 维护优化：新的需求进行建表、索引优化、大表拆分

## 需求分析

### 作用

- 了解系统中所要存储的数据
- 了解数据的存储特点（时效性：过期清理；日志：不适合放在数据库中，或者注意定制清理规则。分库分表？归档？）
- 了解数据的生命周期

### 搞清楚一些问题

- 实体及实体间的关系（1对1，1对多，多对多）
- 实体的属性有什么？
- 唯一标识实体的属性或属性组合？

### 举例：电商网站

用户模块、商品模块、订单模块、购物车模块、供应商模块

#### 用户模块

用户名、密码、电话、邮箱、身份证号、地址、姓名、昵称……

存储特点：组件增加，要永久存储

#### 商品模块

商品编码、商品名称、描述、品类、供应商名称、重量、有效期、价格……

存储特点：对于下线商品可以归档存储

#### 订单模块

订单号、用户姓名、电话、收货地址、商品编号、商品名称、数量、价格、订单状态、订单类型……

存储特点：永久存储（分表、分库存储）

#### 购物车模块

存储特点：不用永久存储（设置归档、清理规则）

#### 供应商模块

存储特点：永久存储

![](/images/posts/14639346317272.jpg)

## 逻辑设计

### 简介

- 将需求转化为数据库的逻辑模型
- 用ER图进行展示
- 与所选用的具体DBMS无关

### 名词

关系、元组、属性、候选码、主码、域、分量 

### ER图例

实体、联系、属性、连接线

### 设计范式（NF）

第一范式、第二范式、第三范式及BC范式，另还有第四、第五范式。

#### 操作异常

- 插入异常
- 更新异常
- 删除异常

#### 数据冗余

相同的数据在多个地方存在，或者某个列由其它列计算得到。

#### 第一范式

定义：数据库表中的所有字段都是单一属性，不可再分的。即表都是二维表。

单一属性是由基本的数据类型所构成。

#### 第二范式

定义：数据库表中不存在非关键字段对任一候选关键字段的部分函数依赖。

部分函数依赖：存在组合关键字中的某一关键字决定非关键字的情况。

所有单关键字段的表都符合第二范式。

不符合第二范式的例子：
![](/images/posts/14639346577960.jpg)

因为存在部分函数依赖：
(商品名称) -> (价格，描述，重量，有效期)
(供应商名称) -> (供应商电话)

存在的问题：插入异常、删除异常、更新异常、数据冗余。

解决方式：
![](/images/posts/14639346749155.jpg)


#### 第三范式

定义：如果数据表中不存在非关键字段，对任意候选关键字段的传递函数依赖，则符合第三范式。

实例：
![](/images/posts/14639346844892.jpg)

(商品名称) -> (分类) -> (分类描述)

存在问题：数据冗余、插入异常、更新异常、删除异常。

解决：
![](/images/posts/14639346929465.jpg)

#### BC范式

定义：Boyce.Codd范式，数据库表中如果不存在任何字段对任一候选关键字段的传递函数依赖则符合BCNF。

实例：
![](/images/posts/14639347213896.jpg)

假定：供应商:供应商联系人 = 1:多，供应商:商品 = 1:多

(供应商，商品ID) -> (联系人，商品数量)
(联系人，商品ID) ->（供应商，商品数量）

存在：

(供应商) -> (供应商联系人)
(供应商联系人) -> (供应商)

所以不符合BCNF。

解决：
![](/images/posts/14639347354230.jpg)

> 此处存疑，知乎上的讨论更好一些：[https://www.zhihu.com/question/24696366](https://www.zhihu.com/question/24696366)

## 物理设计

- 选择合适的DBMS
- 定义数据库、表、字段的命名规范
- 选择合适的字段类型
- 反范式化设计（用空间换取时间）

### 常见DBMS系统

商业数据库：Oracle、SQLServer（企业级项目）
开源数据库：MySQL、PgSQL（互联网项目）

对事务操作要求较高：Oracle

### MySQL常用数据引擎

![](/images/posts/14639347733735.jpg)

### 表和字段命名规则

- 可读性原则
- 表意性原则
- 长名原则

### 字段类型选择原则

- 数字类型 > 日期/二进制 > 字符类型（优先空间小的类型）
- 如：birthday: Int > Datetime > Char(10) > varchar(20)
- MySQL的TIMESTAMP只能存到2037年

![](/images/posts/14639347821112.jpg)

从两个角度考虑：

- 进行数据比较操作时（查询、Join、排序等）：字符处理比数字慢
- 数据处理以页为单位，列长度越小，利于性能提升

char与varchar：

- 若列中存储的数据长度差不多是一致的，用char
- 最大数据长度小于50字节，也考虑用char
- 不宜定义大于50字节的char类型
- 注意UTF8每个汉字占3个字节

decimal与float：

- decimal存储精确数据
- float存储空间开销更小

时间类型如何存储

- 使用int：长度比datetime小，使用不方便，要转换，只能存到2038-1-19 11:14:07
- 根据需要存储的时间粒度选择

### 其它

#### 如何选择主键

- 区分业务主键和数据库主键，前者用于标识，后者是为了优化数据存储
- 考虑是否要顺序增长
- 主键所占空间要尽可能小（使用聚集索引的表，每个索引后会附加主键信息）

#### 避免使用外键约束

- 降低数据导入效率
- 增加维护成本
- 虽不建议，但相关联的列上一定要建立索引

#### 避免使用触发器

- 降低数据导入的效率
- 可能会出现意想不到的数据异常
- 使业务逻辑变复杂

#### 预留字段

- 无法准确知道预留字段的类型
- 无法准确知道预留字段的内容
- 后期维护预留字段的成本同增加一个字段的成本相同
- 严禁使用预留字段！

### 反范式化表设计

- 用空间换时间
- 对第三范式进行违反
- 一定要适度

## 维护和优化

- 维护数据字典
- 维护索引
- 维护表结构
- 在适当的时候对表进行水平拆分或垂直拆分

### 维护数据字典

- 使用第三方工具
- 使用备注字段，可以用select语句导出

### 维护索引

- 出现在Where、group by、order by从句中的列
- 可选择性高的列要放到索引的前面
- 索引中不要包括太长的数据类型
- 并不是越多越好，过多的索引对读写都不好
- 定期维护索引碎片
- 在SQL语句中不要使用强制索引关键字

### 维护表结构

- 使用在线变更表结构的工具
- 同时对数据字典进行维护
- 控制表的宽度和大小

### 数据库中适合的操作

- 批量操作比逐条操作好
- 禁止使用select *
- 控制使用自定义函数
- 不要使用全文索引

### 表的拆分

#### 垂直拆分：

- 经常一起查询的列放一起
- text,blob等大字段拆分到附加表中

#### 水平拆分：

- 为了控制表的大小。
- 常用方式：主键Hash

