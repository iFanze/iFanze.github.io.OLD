---
layout: post
title: 【慕课网】Java高并发秒杀API（四）：高并发优化
author: 孟凡泽
date: 2016-05-29 23:55:40 +0800
tag: [Java, 高并发]
categories: 笔记 @慕课网
---

注：续前文。这两天去上海参加了华测的一个参观交流活动，感觉比起同样前途光明的GIS行业，还是互联网更适合我呢。刚回来就发现慕课网这个视频最后一部分更新啦~赶快把第一章综述的内容看了看，大致了解了下高并发产生的瓶颈和CDN、Redis、存储过程等在进行并发优化的作用等等。做笔记如下。具体的编码我想等到自己把前面三课的内容实现了之后再继续学习吧。

## 高并发优化分析

分析可能产生高并发的地方：

![](/images/posts/14645378066039.jpg)


### 详情页
![](/images/posts/14645378988870.jpg)

使用CDN（内容分发网络）来加速用户获取数据：

- 一般部署在离用户最近的网络节点上
- 命中CDN不需要访问后端服务器
- 互联网公司会自己搭建，或租用

### 获取系统时间

- 获取系统时间不用优化：因为Java服务器访问一次内存大约只有10ns。

### 秒杀地址接口分析

- 无法使用CDN缓存
- 适合服务器缓存：redis等（1wQPS）
- 一致性维护成本低（超时穿透/主动更新）

![](/images/posts/14645381091286.jpg)

### 秒杀操作优化分析

- 无法使用CDN缓存
- 后端缓存困难：库存问题，要通过MySQL的事务保证一致性。
- 一行数据竞争：热点商品

## 其他方案分析

![](/images/posts/14645365894875.jpg)

- 可以扛住非常非常高的并发，腾讯阿里常用
- 运维成本和稳定性：NoSQL、MQ等都是分布式服务，不如MySQL稳定。需要一个强大的运维团队
- 开发成本：数据一致性，回滚方案等。工程师对这些要非常熟悉
- 幂等性难保证：重复秒杀问题。加大成本
- 是一个不适合新生的架构，主要因为如上这些成本性问题

## 网络延迟和CG

- 对MySQL一条update进行压力测试：约4wQPS——不算低
- Java控制事务行为分析：
![](/images/posts/14645385010686.jpg)


- 瓶颈分析：

![](/images/posts/14645385711091.jpg)

Java GC：Garbage Collection，垃圾回收机制。Java + SQL + 网络延迟 + GC  ：这些共同导致低效

### 优化分析：

- 行级锁在Commit之后释放
- 优化方向：减少行级锁持有时间

### 延迟分析（同城机房和异地机房）

![](/images/posts/14645372241542.jpg)
![](/images/posts/14645372413927.jpg)

### 如何判断Update成功？

- Update自身没报错
- 客户端确认Update影响记录数
- 优化思路：把客户端逻辑放在MySQL服务器端，避免网络延迟和GC影响
- 两种解决方案：修改源码定制SQL方案；使用存储过程让整个事务在MySQL端完成

## 优化总结

- 前端控制：暴露接口，按钮防重复
- 动静态数据分离：CDN缓存，后端缓存
- 事务竞争优化：减少事务锁时间

## Redis后端缓存优化编码

（待更新）

## 并发优化

（待更新）

## 系统部署架构

（待更新）

## 课程总结

（待更新）



