
---
layout: post
title: 使用VPS、Shadowsocks、kcptun搭梯子
author: 孟凡泽
date: 2016-11-20 19:12:40 +0800
tag: 网络
categories: 笔记
---

从我家院子出来进去挺不方便的，只能用梯子从墙上翻过去。自己也试过很多种梯子了，各种打着VPN标签的也好，PAC标签的也好，免费的或者花钱买来的，他们的质量和爬过墙需要耗费的时间成本总不那么理想。这一次，终于花费了两天的时间自己动手做了个，已经很大程度上符合自己的预期了~

主要思想：租用国外的VPS，使用Shadowsocks(简称ss)把它搭建成代理服务器，再使用kcptun优化速度。

## 一、用到的工具

### 1.1 VPS

国内的云服务厂商，如腾讯云阿里云，海外的节点甚至香港的节点都很贵，不考虑了…（腾讯云对学生1元/月的国内服务器还是很棒的。）

而国外的，通过各方的推荐，最后选择了[搬瓦工](https://bwh1.net/)。实惠、速度快。

![](/images/posts/14795638920454.jpg)
我选择的是每月5刀的这款，最方便的是这个网站支持支付宝。这也是唯一需要花钱的地方了，其实3刀每月的估计也够，带宽是一样的，按年付费还会更便宜，只是机器配置和每月流量少一些。这样的开销绝对比直接买各种VPN划得来，并且速度更快、终端数没限制、连接更稳定、流量够用，并且还获得了一台海外的服务器以后可以搭更多你想要的服务。

### 1.2 ShadowSocks

VPN ≠ 代理，只是大多数人是利用VPN实现代理的功能，VPN其实主要是用在外网访问内网的情景中。具体对比参见：

> [技术角度分析一下VPN和代理服务器的区别？ - 知乎](https://www.zhihu.com/question/25143289)

VPN使用的协议有PPTP、L2TP等等，但是给我的感觉是在我们实验室的环境下能够成功连接的几率基本为0。

而代理的设置往往在很多浏览器、应用软件、甚至是系统控制面板的配置界面里可以看到，有两种常用的：

第一种：自动代理。需要填写一个PAC文件的地址。这个文件里记录有若干站点的访问规则，这样系统就知道对一个特定的网站要走怎样的代理，或者是不走代理了。这种方式的优点是配置简单，非常轻量级，比如我之前经常在用的这个公共PAC：

> [PAC全自动代理脚本，免费代理，proxy代理，开源项目官网 - itzmx.com](https://pac.itzmx.com/)。

但是这种公共PAC的缺点是不稳定、慢，现在每次第一次用还需要输入特定的用户名和密码。不过你需要做的其实很简单，直接在系统的网络配置界面或者Chrome的代理切换插件里类似这样配置即可：

![](/images/posts/14795765365109.jpg)

第二种：手动设置代理，所有流量都走代理通道。一般是填写代理服务器的IP和端口，有些还需要用户名和密码。
![](/images/posts/14796206378825.jpg)


常用的代理方式主要包括：HTTP代理、HTTPS代理、SOCKS代理。至于这三者的区别，我的理解是，HTTP代理和HTTPS代理工作在OSI模型的应用层，并且只能各自代理HTTP或HTTPS协议通讯。而SOCKS代理工作在会话层，包括4和5两个版本，后者比前者多了对鉴定、UDP、IPv6等的支持，只是单纯传递数据包，不关心具体协议和用法，所以快很多。更具体的区别可参阅：

> [代理服务器 - 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8)
> 
> [超文本传输协议 - 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE)
> 
> [SOCKS - 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/SOCKS)

而Shadowsocks，顾名思义，主要使用的是socks协议。而我们的主要任务就是要在租用的VPS上安装SS的服务器端让它能够提供代理服务，之后就是在客户端上填入参数进行配置了（或者使用它提供的客户端，各操作系统都有）。

遗憾的是，Shadowsocks的作者已经迫于一些压力撤掉了Github上的代码，估计现在只能使用流传的版本？

不过不用担心，搬瓦工的VPS控制面板上提供了一键安装Shadowsocks Server的功能，真是太方便了…

### 1.3 kcptun

完成上述两部分后，再配置下客户端实际上就已经成功了，只是速度还不理想。通过搜索发现这个速度还是有提升的空间的。首先发现的是FinalSpeed和它的高级版TCPSpeed，后者是前者的升级收费版，并且开发者撤下了前者在Github上的代码，不考虑了…

而kcptun就是很棒的一个开源替代品。使用了KCP协议，看看它的介绍：

> KCP 是一个快速可靠协议，能以比 TCP浪费10%-20%的带宽的代价，换取平均延迟降低 30%-40%，且最大延迟降低三倍的传输效果。
> 
> [快速可靠协议：KCP - OPEN 开发经验库](http://www.open-open.com/lib/view/open1428414542776.html)
> 
> [xtaci/kcptun: A Simple UDP Tunnel Based On KCP](https://github.com/xtaci/kcptun)

我们需要做的是在客户端与VPS的SS服务器之间分别配置服务器端和客户端，然后让客户端上的kcptun代理流量，就是这样子：

![](/images/posts/14795785737529.png)

虽然整个架构变复杂了一些，但是速度的提升真的很显著，使用后流畅观看Youtube上的1080p视频不是问题。

## 二、具体流程

### 2.1 购买和管理VPS

这里唯一要注意的就是机房的位置，搬瓦工提供五个位置可选，其中位于美国西部的Los Angeles和Phoenix的机房会快一些。操作系统当然是用CentOS。

购买完成后即可通过他提供的KiwiVM控制面板进入VPS的管理界面。这里可以查看VPS的配置、资源使用，也有在Web端进行文件管理、密码修改、系统更换的操作，甚至还提供了3种能在Web上直接使用的Shell。如果选择的机房位置不满意，也可以很方便地进行更换，当然这样的话IP会变，但数据都会帮你进行无缝地转移。

当然最方便地还是用自己电脑上的终端（Windows上可以使用putty、cygwin等）通过`ssh`登录，要注意的是SSH端口并不是默认的22，可以在KiwiVM主页上找到。系统还会为你生成默认的root用户密码，这也需要你登录后运行`passwd`进行修改的（推荐）。

### 2.2 安装Shadowsocks Server

在KiwiVM控制面板列表的最后一项可以找到，在知道Github上SS源码被撤下后发现它提供一键安装简直不要太方便。安装完成后，SS Server运行的端口、加密方式和密码都会简单直白地告诉你。

然后下面就已经给出了后续要做的事情了，建议按他的步骤下载相应的客户端进行配置和测试，如果成功，继续下一步进行我们的提速方案。

![](/images/posts/14796111155315.jpg)

### 2.3 kcptun的使用

kcptun的源码托管在：

> [xtaci/kcptun: A Simple UDP Tunnel Based On KCP](https://github.com/xtaci/kcptun)

但是实际上有人做了一个一键安装脚本：

> [kuoruan/kcptun_installer: kcptun一键安装脚本](https://github.com/kuoruan/kcptun_installer)
>
> [kcptun服务端一键安装脚本,喜闻乐见的多用户支持](https://blog.kuoruan.com/110.html)
    
要做的就是使用VPS的Shell，`git clone`下这个repository，在目录下运行：

```
./kcptun.sh update
```

接下来就是按照提示输入参数即可，要注意SS的端口不要输错了，不明白的参数均保持默认即可，不用记住他们，因为最后一个界面都罗列出来了，要将这些内容保存下来，后面配置客户端会用到：
![](/images/posts/14796121924338.jpg)

### 2.4 客户端配置

#### 2.4.1 客户端（macOS）

**第一步是下载并运行kcptun的客户端**

下载下来客户端程序，放置在你喜欢的、不会变动的位置，注意版本号尽量和服务器端保持一致吧：

![](/images/posts/14796123234236.jpg)
在此目录下新建一个文件，如`client.conf`，将上一步最后的推荐客户端配置写入这个文件（一个JSON）。

运行以下命令，我们要让它在后台一直运行：

```
nohup ./client_darwin_amd64 -c ./client.conf 1>> today.out 2>> today.err &
```

这样整个梯子应该就全部搭好了。后续就是一些配置操作。

**第二步是配置Shadowsocks客户端**

如果之前有测试过SS Server是否配置成功，你应该已经安装了相应的Shadowsocks客户端。类似这样：

![](/images/posts/14796127457288.jpg)


其中被色块覆盖掉得地方是你的VPS远程地址。

而启用kcptun后，我们需要使用的是本机地址和配置文件中配置的本机端口（其中`localattr`的值）：

![](/images/posts/14796129838853.jpg)

大功告成。剩下的是开启：

![](/images/posts/14796172679626.jpg)

实际上，可以通过macOS的网络配置界面发现，自动代理模式采用的是PAC，并且这个PAC文件可以提供了一键更新；全局模式则是直接采用的SOCKS代理。这样，如果只是需要在特定软件中实现代理，就只要填写相应的参数就行了，比如Chrome的话，使用SwitchyOmega等插件。

#### 2.4.2 客户端（终端）

即便是在系统的网络设置中配置了代理，可是在终端中依然不能实现，可有时候用终端装个什么东西（比如`gem install`）也是隔着墙的。目前我找到的解决方案是使用tsocks。这里有使用homebrew在macOS上进行安装和使用的方法：

> [mac osx使用homebrew安装tsocks-爱折腾技术网](http://blog.aizhet.com/Apple/17446.html)

（不过最后`tsocks wget https://google.com`还是会失败的，应该是这个请求不允许非浏览器访问吧。）

#### 2.4.3 客户端（Android）

在搞定桌面平台的配置后，安卓上的配置就显得简单了。只需要在Google Play上下载Shadowsocks的客户端，进行类似的配置即可。并且，安卓客户端上自带了对kcptun的支持，只需要填入之前配置kcptun服务器端最后提供给你的手机端用的参数即可。

并且，安卓端上可以控制对哪些应用使用代理。

![](/images/posts/14796222521508.jpg)



